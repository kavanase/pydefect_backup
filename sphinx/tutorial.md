# Tutorial of pydefect
-----------------------

We here illustrate how to use the pydefect code.

**Note1: Pydefect supports only the vienna ab-initio simulation package (VASP) and so we suppose the file names (e.g., POSCAR, POTCAR) and computational techniques (e.g., periodic boundary condition) used in VASP.**

**Note2: Units used in pydefect are eV for energy and <span>&#8491;</span> for length following the vasp convention.**

**Note3: Only nonmagnetic host materials are allowed.**

Usually, point-defect calculations in non-metallic solids are intricate as shown in the workflow below;
some tasks can be performed concurrently, while others must follow some other tasks.

![](flowchart.png)

Here, we suppose the following directory tree.
The `<project_name>` is usually the name of material or that with crystal structure, e.g., rutile-TiO<sub>2</sub>.
```
<project_name>
 │
 ├ pydefect.yaml
 │
 ├ unitcell/ ── structure_opt/
 │            ├ band/
 │            └ dos/
 │            
 ├ competing_phases/ ── <competing_phase 1>
 │                    ├── <competing_phase 2>
 │                    ....
 │  
 └ defects/ ── perfect/  
              ├─ Va_X_0/
              ├─ Va_X_1/
              ├─ Va_X_2/
             ...
```
We recommend the users to follow the same directory structure as the default of `pydefect` assumes it. 
Details of the process are examined step by step using an example of MgO calculated using the PBEsol functional, which is a default of `pydefect`.
Other examples are also shown in the subsequent tutorials.

### 1. Relaxation of unit cell
Point-defect calculations are generally performed at a fully relaxed structures by the given functional and projector augmented wave (PAW) potentials.
This allows us to avoid the artificial strain and stress which is responsible for the unwanted supercell size dependence. 
Therefore, one usually begins with optimizing lattice constants and fractional coordinates of atomic positions in the unitcell. 

We first prepare `POSCAR` of the pristine bulk unitcell, and create `unitcell/` directory and `unitcell/structure_opt/` sub-directory and move there. 
In this tutorial, `/` means a directory at any time.
`pydefect` can construct the vasp input files, namely INCAR, POTCAR, KPOINTS files, for various tasks and exchange-correlation (XC) functionals with simple command line tools.
For instance, vasp input files to optimize unitcell using the PBEsol functional are generated by the following command.
Here, the pbesol functional is a default, so if one wants to change the XC functional, use the `-x` option. 
```
python $PATH_TO_PYDEFECT/pydefect/main.py vasp_oba_set -t structure_opt
```
where `vasp_oba_set`, or its abbreviation (`vos`) , is a sub-command option of pydefect.
In pydefect, all the sub-commands have their own abbreviations, which would be better for advanced users.

When `pydefect` creates vasp input files, analyze or visualize vasp output files, 
the `VISE` (=`vasp integrated supporting environment`) library, written by Kumagai largely on the basis of [pymatgen](http://pymatgen.org) developed by Materials Project team, is adopted.
Therefore, as shown [pymatgen web page 1](https://pymatgen.org/usage.html) or [2](https://pymatgen.org/_modules/pymatgen/io/vasp/inputs.html), 
we need to set the PMG_DEFAULT_FUNCTIONAL and PMG_VASP_PSP_DIR in the .pmgrc.yaml file at the home directory, e.g.,
```
PMG_DEFAULT_FUNCTIONAL: PBE_54
PMG_MAPI_KEY: xxxxxxxxxxxxxxxx
PMG_VASP_PSP_DIR: /home/kumagai/potcars/
```
Here, `PMG_MAPI_KEY` is required for querying `POSCAR`s of competing materials as shown later.

In `VaspObaSet` in `VISE`, we provide the default `POTCAR` set regularly we use, but of course, users can adopt their favorite `POTCAR` set.
In `pydefect`, users can control various types of parameters using the `pydefect.yaml` file.
For example, for `vasp_oba_set` and `defect_vasp_oba_set` which appear later, we can use `potcar_set` key as follows
If you write `my_potcar.yaml` as 
```
potcar_set: Mg_pv O_h
```
Then, the Mg_pv and O_h `POTCAR` files are used insteadof normal Mg and O `POTCAR` files.

Note that `pydefect` tries to find the `pydefect.yaml` file from the current working directory to the parent directly up to the home or root directory.
Therefore, when `pydefect.yaml` is located at the top directory of the project as shown above directory tree,
the parameters are always used for the `pydefect` commands.
There are so many keys for `pydefect.yaml`, which is shown here.
For example, one can use
```
xc: hse
```
for XC functional.

There are also many options for each sub-command, so please refer its help by e.g.,
```
python ~/my_bin/pydefect/pydefect/main.py vos -h
```
for details.

Note that the structure optimization must be generally iterated with 1.3 times larger cutoff energy 
until the forces and stresses converge at the first ionic step so as to reduce the errors caused by the Pulay Stress to an acceptable accuracy.
See [vasp manual](https://cms.mpi.univie.ac.at/vasp/vasp/Volume_vs_energy_volume_relaxations_Pulay_Stress.html) or [wikipedia](https://cms.mpi.univie.ac.at/vasp/vasp/Volume_vs_energy_volume_relaxations_Pulay_Stress.html) for details.
Note that such iteration of the vasp calculations is not supported by pydefect, but one can easily write the simple runshell scripts to do so.

### 2. Calculation of band, DOS, and dielectric tensor

We then calculate the band structure (BS), density of states (DOS), and dielectric constant.
In the defect calculations, the BS and DOS are used for determining the valence band maximum (VBM) and conduction band minimum (CBM), 
while the dielectric constant, a sum of electronic and ionic dielectric tensors, is needed for correcting the defect formation energies and eigenvalues of defect-induced deep states.

First, we create `band/`, `dos/` and `dielectric/` in `unitcell/` and copy POSCAR from `unitcell/structure_opt` and type the following command in each directory,
```
python ~/my_bin/pydefect/pydefect/main.py vos -t band
```
```
python ~/my_bin/pydefect/pydefect/main.py vos -t dos
```
```
python ~/my_bin/pydefect/pydefect/main.py vos -t dielectric
```
and run the vasp calculations.

Here, the band path is determined based upon the [seekpath code](https://www.materialscloud.org/work/tools/seekpath), 
so if one uses the plot for publication or presentation, please cite the following paper.
- [Y. Hinuma, G. Pizzi, Y. Kumagai, F. Oba, I. Tanaka, Band structure diagram paths based on crystallography, Comp. Mat. Sci. 128, 140 (2017).](https://www.sciencedirect.com/science/article/pii/S0927025616305110?via%3Dihub) 
  DOI: 10.1016/j.commatsci.2016.10.015 (the "HPKOT" paper; arXiv version: arXiv:1602.06402).

pydefect also provides the plotters of BS and DOS based on `VaspObaSet` with `plot_band` (=`pb`) and `plot_dos` (=`pd`) sub-commands.
Type the following commands in `band/` and  `dos/`, respectively. 
```
python ~/my_bin/phos_pbesol/obadb/obadb/analyzer/main.py pb -v vasprun.xml -k KPOINTS -f band.pdf
```
```
python ~/my_bin/phos_pbesol/obadb/obadb/analyzer/main.py pd -v vasprun.xml -f dos.pdf
```

### 3. Gathering unitcell information related to point-defect calculations

We next collect the bulk information relevant to point-defect calculations, namely band edges (for defect-formation energies), 
electronic and ionic contributions to dielectric tensor (for corrections), unitcell volume, and unitcell DOS (both for carrier and defect concentrations),
using the `unitcell_results` (=`ur`) sub-command.
```
python ~/my_bin/pydefect/pydefect/main.py ur --static_diele_dir dielectric --ionic_diele_dir dielectric --band_edge_dir band --volume_dir dielectric --total_dos_dir dos --json_file unitcell.json -o OUTCAR-finish -p POSCAR-finish -v vasprun.xml
```
In this command, we suppose that OUTCAR and CONTCAR are renamed to OUTCAR-finish and POSCAR-finish, respectively, as an example, using `-o` and `-p` options.
If you write the following in the `pydefect.yaml` file, 
```
# VASP file names
outcar: OUTCAR-finish
contcar: POSCAR-finish
vasprun: vasprun.xml
procar: PROCAR
# directory names
volume_dir: unitcell/structure_opt
static_diele_dir: unitcell/dielectric
ionic_diele_dir: unitcell/dielectric
band_edge_dir: unitcell/band
dos_dir: unitcell/dos
```
it's okay to simply type
```
python ~/my_bin/pydefect/pydefect/main.py ur
```

With this command, `unitcell.json` is generated, which will be used for the analysis later.
Generally, json files are less readable for human beings, so we implement `print` option to generate readable output from json files, like
```
python ~/my_bin/pydefect/pydefect/main.py ur --print
```
Here, we show an example of the unitcell information.
```
vbm (eV): 3.067
cbm (eV): 7.726
static dielectric tensor: 
 [3.16, 0.0, 0.0]
 [-0.0, 3.16, 0.0]
 [-0.0, -0.0, 3.16]
ionic dielectric tensor: 
 [6.81, 0.0, -0.0]
 [0.0, 6.81, -0.0]
 [-0.0, -0.0, 6.81]
total dielectric tensor: 
 [9.97, 0.0, 0.0]
 [0.0, 9.97, 0.0]
 [-0.0, -0.0, 9.97]
volume (A^3): 18.65
Total DOS: Exists
```
Since the total dos is so long, we show only whether it is set or not. 

### 4. Calculation of competing phases
When a defect is introduced, atoms are exchanged with the hypothetical atomic reservoirs within the thermodynamics framework.
In order to calculate a free energy of defect formation that is approximated with the defect formation energy in most cases,
we need to determine chemical potentials of exchanged atoms accompanied with creating defects.
Usually, we consider the chemical potentials at the condition where competing phases coexist with the host material,
which are determined from the chemical potential diagram.

For this purpose, we create directories in `competing_phases/` for competing phases including VASP input sets in each directory.
Using the `chempotdiag` library developed and managed by Akira Takahashi, 
we can retrieve POSCARs of the stable or slightly unstable competing phases from [the Materials Project (MP)](https://materialsproject.org).
For this purpose, one needs [the API keys](https://materialsproject.org/open) of the MP as mentioned above.
Here, as an example, we obtain the competing materials with MgO of which energy above hull is less than 0.5 meV/atom using 
```
python ~/my_bin/phos_pbesol/obadb/obadb/analyzer/chempotdiag/main.py cpd -m -el Mg O -ch 0.5
```
Particular molecules, namely O<sub>2</sub>, N<sub>2</sub>, F<sub>2</sub>, H<sub>2</sub>O, N<sub>2</sub>, NH<sub>3</sub>, NO<sub>2</sub>, P<sub>2</sub>, and P<sub>4</sub>, 
are not retrieved from MP but created by `chempotdiag` itself since these molecules have been calculated as solids in MP, which could be inadequate for competing phases for defect calculations.

The bulk structure, namely MgO in this example, has already been calculated, so we do not have to iterate the same calculations, 
but make a symbolic link by `ln -s ../unitcell/structure_opt MgO` after removing `Mg1O1_mp-126/`.
At this point, you can find these directories under 2019/8/28),
```
Mg4O8_mp-2589/  Mg9_mp-1094122/  MgO@  O2molecule_pydefect/
```

We then generate `INCAR`, `POTCAR`, `KPOINTS` files for other competing solids or molecules.
In order to compare the total energies, we need to use the same cutoff energy, `ENCUT`, which is increased to 1.3 times of max `ENMAX` between the constituent POTCARs.
In case of MgO, `ENMAX` of Mg and O are 200.0 and 400.0, so we need to set `ENCUT = 520`, using the `vasp_oba_set` sub-command
```
python ~/my_bin/pydefect/pydefect/main.py vos -t structure_opt -is ENCUT 520 --dirs *_mp*/
```

<p>Note, if competing phases are gases, we need to change `ISIF` to 2 so as not to relax the lattice constants (see [vasp manual](https://cms.mpi.univie.ac.at/wiki/index.php/ISIF)), 
and `KPOINTS` to the &Gamma; point sampling.</p>

In such case, type as follows,
```
python ~/my_bin/pydefect/pydefect/main.py vos -t structure_opt -is ENCUT 520 ISIF 2 -vos_kw is_cluster True --dirs O2molecule_pydefect
```
where O2molecule_pydefect is a directory for the O<sub>2</sub> molecule model. 

After finishing the vasp calculations, we can generate the chemical potential diagram with
```
python ~/my_bin/phos_pbesol/obadb/obadb/analyzer/chempotdiag/main.py cpd -v */ -c MgO -y -s cpd.pdf
```
If you rename the CONTCAR and OUTCAR files to e.g., POSCAR-finish and OUTCAR-finish, type
```
python ~/my_bin/phos_pbesol/obadb/obadb/analyzer/chempotdiag/main.py cpd -v */ -p POSCAR-finish -o OUTCAR-finish -c MgO -y -s cpd.pdf
```
See help of `chempotdiag` for more other options.
Especially, there are some parameters of the partial pressure and temperature for gas phases to determine the chemical potentials.
With this command, we depict the Mg-O chemical potential diagram that is saved as `cpd.pdf` which looks like

![](cpd_MgO.png)

<!--
In ternary case, it looks like
![](cpd_BaSnO3.png)
-->

Values at the vertices at the MgO region written in `vertices_MgO.yaml` are shown as follows.
```
A: {Mg: 0.0, O: -5.910971904865118}
B: {Mg: -5.847874231666665, O: -0.06309767319845339}
compound: MgO
pressure: null
standard_energy: {Mg: -1.7294249733333331, O: -4.8720259618015485}
temperature: 0
```
Here, `standard_energy` are the energies of the most stable simple substances or simple gas phases, 
and A--B show the relative chemical potentials at the vertices shown in `cpd_MgO.pdf`. 

### 5. Selection of a supercell
So far, we have finished the calculations of the unit cell and competing phases, and are eventually ready for point-defect calculations. 
Let's create `defect/` directory and copy unitcell `POSCAR` file from *e.g.* `unitcell/dos/` to `defect/`

Firstly, we need to determine the shape and size of the supercell.
pydefect recommends a nearly isotropic (and sometimes cubic-like) supercell composed of moderate number of atoms.
For this purpose, use the `recommend_supercell` (=`rs`) sub-command,
```
python ~/my_bin/pydefect/pydefect/main.py rs
```
Then, `UPOSCAR` and `SPOSCAR` that are the POSCARs for the unitcell and supercell, respectively, are generated.

Although pydefect constructs `SPOSCAR` based on the *conventional* unitcell by default, 
it can also expand the *primitive* unitcell with `-pr` option.
(If centering is absent, these two are the same.)

It is also possible to change the lattice angle of the supercell from those of the conventional or primitive unitcell,
but not a good idea for point-defect calculations.
For example, we can make a supercell in which a-, b-, and c-axes are mutually orthogonal.
However, its lattice breaks the original hexagonal symmetry, which reduces the accuracy of the point-defect calculations.
Furthermore, it prevents determination of point group of defects.

When the Bravais lattice is rhombohedral, the lattice angle could be too small or too large (e.g., 20 or 160 degrees).
In such case, a simple supercell expansion is not adequate as the defects do not arrange evenly in the real space.
Therefore, pydefect expand the cell in a very specific way.
Details are written elsewhere.

### 6. Construction of defect initial setting
We then create the initial setting file for point defects with the `initial_setting` (=`is`) sub-command.
```
python ~/my_bin/pydefect/pydefect/main.py is
```
With this command, we can build the `defect.in` file, which contains the full information on what kind of defects are to be generated automatically.
At the same time, `DPOSCAR`, POSCAR used for the defect calculations, is created. 
If one follows this tutorial, `DPOSCAR` should be the same as `SPOSCAR`, while if one prepares their own supercell `POSCAR`, an order of elements may be changed.

An example of `defect.in` looks as follows:
```
  Space group: Fm-3m

Transformation matrix: 2 0 0 0 2 0 0 0 2
Cell multiplicity: 32

   Irreducible element: Mg1
        Wyckoff letter: a
         Site symmetry: m-3m
          Coordination: O: 2.1 2.1 2.1 2.1 2.1 2.1
      Equivalent atoms: 0..31
Fractional coordinates: 0.0000000  0.0000000  0.0000000
     Electronegativity: 1.31
       Oxidation state: 2

   Irreducible element: O1
        Wyckoff letter: b
         Site symmetry: m-3m
          Coordination: Mg: 2.1 2.1 2.1 2.1 2.1 2.1
      Equivalent atoms: 32..63
Fractional coordinates: 0.2500000  0.0000000  0.0000000
     Electronegativity: 3.44
       Oxidation state: -2

Interstitials: all
Complex defects: 
Antisite defects: 

Substituted defects: 

Maximum Displacement: 0.2

Exceptionally included: 
Exceptionally excluded: 

Cutoff region of neighboring atoms: 2.95
Symprec: 0.01
Angle tolerance: 5
```
The `Coordination` is shown for the atoms whose distances from the defect are less than 1.4 times of the minimum inter-atom distance in the perfect cell.
This parameter is also controlled with the `pydefect.yaml` file.

If we want to add dopants *a posteriori*, we can type as follows.
```
python ~/my_bin/pydefect/pydefect/main.py is --print_dopant Na
```

This example of Na dopant prints 
```
   Dopant element: Na
Electronegativity: 0.93
  Oxidation state: 1
```

By inserting this with an editor to `defect.in` and modify `Substituted defects` as follows
```
  Space group: Fm-3m

Transformation matrix: 2 0 0 0 2 0 0 0 2
Cell multiplicity: 32

   Irreducible element: Mg1
        Wyckoff letter: a
         Site symmetry: m-3m
          Coordination: O: 2.1 2.1 2.1 2.1 2.1 2.1
      Equivalent atoms: 0..31
Fractional coordinates: 0.0000000  0.0000000  0.0000000
     Electronegativity: 1.31
       Oxidation state: 2

   Irreducible element: O1
        Wyckoff letter: b
         Site symmetry: m-3m
          Coordination: Mg: 2.1 2.1 2.1 2.1 2.1 2.1
      Equivalent atoms: 32..63
Fractional coordinates: 0.2500000  0.0000000  0.0000000
     Electronegativity: 3.44
       Oxidation state: -2

   Dopant element: Na
Electronegativity: 0.93
  Oxidation state: 1

Interstitials: all
Complex defects: 
Antisite defects: 

Substituted defects: Na_Mg1 

Maximum Displacement: 0.2

Exceptionally included: 
Exceptionally excluded: 

Cutoff region of neighboring atoms: 2.95
Symprec: 0.01
Angle tolerance: 5
```

Some people might also wonder why we need two supercells, namely SPOSCAR and DPOSCAR.
The difference between these two could only be the sequence of the irreducible sites.
In DPOSCAR file, the irreducible sites are sequentially sorted such that the defect.in file becomes more concise.      
This is also useful when the supercell is prepared by another way.
However, the user must insert the following line to the first header line of `SPOSCAR`.
```
trans_mat: 2 0 0 0 2 0 0 0 2, multi: 32, isotropy: 0.0
```

There are so many tips related to `defect.in`.
1. The antisites and substituted defects are determined from the difference of the electronegativity. 
   Although default is 1.0 <span>&#8491;</span>, you can change it using `-e` option to e.g., 1.5.
   ```
   python ~/my_bin/pydefect/pydefect/main.py is -e 1.5
   ```

2. The oxidation states determine the defect charge state.
   For instance, the vacancies of Sn<sup>2+</sup> takes 0, -1, -2, while those of Sn<sup>4+</sup> take 0, -1, -2, -3, -4 charge states.
   In case of interstitials, the interstitials of Sn<sup>2+</sup> takes the 0, +1, +2, while those of Sn<sup>4+</sup> take 0, +1, +2, +3, +4 charge states.
   For the antisites and substituted defects, pydefect considers all possible combinations of vacancies and interstitials.
   So, for example, Sn<sup>2+</sup>-on-S<sup>2-</sup> takes 0, +1, +2, +3, +4 charge states.
   The oxidation states are determined using the `oxi_state_guesses` method of `Composition` class in `pymatgen`.

3. By default, positions of atoms neighboring a defect are perturbed such that the symmetry is lowered, but it is unwanted in some cases.
   Then, `Maximum Displacement` is simply set to 0.


### 7. Decision of interstitial sites
In addition to vacancies and antisites, one may want to take into account the interstitials.
For this purpose, we need to determine the interstitial sites.
Most people determine them by seeing the host crystal structures, 
while there are a couple of procedures that recommend the interstitial sites.
However, it is not an easy task to speculate the most likely interstitial sites because they also depend on the substituted element in general.
For instance, when positively charged cations with closed shells are substituted (e.g., Mg<sup>2+</sup>, Al<sup>3+</sup>), 
the largest vacant space should be most likely interstitial sites, as they tend not to make bonding with other atoms. 
On the other hand, in case of a proton (H<sup>+</sup>), 
it prefers to locate near O<sup>2-</sup> or N<sup>3-</sup> to form the strong O-H or N-H bonding.
Conversely, a hydride ion (H<sup>-</sup>) should prefer to locate at very much different places. 
Therefore, we need to be careful when determining the interstitial sites.

`pydefect` implements a recommendation of the interstitial sites using the unitcell charge density
using the `ChargeDensityAnalyzer` class implemented in `pymatgen`.
To use this, we need to generate `CHGCAR` based on the `UPOSCAR` file.
(Of course, if you already have `CHGCAR` at the unitcell calculations, you can use it, but be sure the structure is the same as `UPOSCAR`.)
For this purpose, make `chgcar/` and copy UPOSCAR to `chgcar/POSCAR` and type
```
python ~/my_bin/pydefect/pydefect/main.py vos -t structure_opt -is LCHARG True LWAVE False -vos_kw standardize_structure False
```
Then, type
```
python ~/my_bin/pydefect/pydefect/main.py i --chgcar CHGCAR
```
With this, one can obtain the following output.    
```
      a     b     c  Charge Density
0  0.25  0.75  0.75        5.209053
1  0.25  0.75  0.25        5.209053
2  0.25  0.25  0.75        5.209053
3  0.25  0.25  0.25        5.209053
4  0.75  0.75  0.75        5.209053
5  0.75  0.75  0.25        5.209053
6  0.75  0.25  0.75        5.209053
7  0.75  0.25  0.25        5.209053

++ Inequivalent indices and site symmetries ++
0 -43m
```



To add the interstitial site at e.g., 0.25  0.25  0.25, we use the `interstitial` (=`i`) sub-command like
```
python ~/my_bin/pydefect/pydefect/main.py i -c 0.25 0.25 0.25
```

`interstitials.yaml` is then generated, which show information related to the interstitial sites.
```
i1:
  representative_coords: [0.125, 0.125, 0.125]
  wyckoff: c
  site_symmetry: -43m
  multiplicity: 64
  coordination_distances:
    Mg: [1.82, 1.82, 1.82, 1.82]
    O: [1.82, 1.82, 1.82, 1.82]
  method: manual
```
If we want to add another site at e.g. 0.25 0.25 0, interstitials.yaml is updated as follows:
```
i1:
  representative_coords: [0.125, 0.125, 0.125]
  wyckoff: c
  site_symmetry: -43m
  multiplicity: 64
  coordination_distances:
    Mg: [1.82, 1.82, 1.82, 1.82]
    O: [1.82, 1.82, 1.82, 1.82]
  method: manual
i2:
  representative_coords: [0.125, 0.125, 0.0]
  wyckoff: c
  site_symmetry: -43m
  multiplicity: 64
  coordination_distances:
    Mg: [1.49, 1.49, 2.58, 2.58, 2.58, 2.58]
    O: [1.49, 1.49, 2.58, 2.58, 2.58, 2.58]
  method: manual
```

When we try to add the site that is very close to the constituent atoms or other interstitial sites,
you will get the warning message as 
```
2019-08-31 17:16:08,029 WARNING pydefect.util.structure_tools Inserted position is too close to X0+.
  The distance is 0.210 A.
```
where X0+ means another interstitial site,
but be careful the site is anyway added.

Once we generate the interstitial.yaml, we also need to modify the `Interstitials` in `defect.in` file
```
Interstitials: i1 i2
```
Or we can type the `is` sub-command again as follows.
```
python ~/my_bin/pydefect/pydefect/main.py is --interstitial_sites i1 i2 --dopants Na
```

### 8. Creation of defect calculation directories
We next create directories for point-defect calculations by the `defect_vasp_oba_set` (=`dvos`) sub-command like
```
python ~/my_bin/pydefect/pydefect/main.py dvos
```

With this command, a lot of directories are created, including `perfect`.

If you want to calculate only oxygen vacancies, you can restrict the calculated defects with `-kw` option and a python regular expression,
```
python ~/my_bin/pydefect/pydefect/main.py dvos -kw "Va_O[0-9]?_[0-9]+"
```
, which create these directories.
```
perfect/ Va_O1_0/ Va_O1_1/ Va_O1_2/
```

If you again type the same command, the following information is shown,
```
2019-07-09 17:22:21,078 WARNING pydefect.input_maker.defect_entry_set_maker    perfect already exists, so nothing is done.
2019-07-09 17:22:21,399 WARNING pydefect.input_maker.defect_entry_set_maker    Va_O1_0 already exists, so nothing is done.
2019-07-09 17:22:21,744 WARNING pydefect.input_maker.defect_entry_set_maker    Va_O1_1 already exists, so nothing is done.
2019-07-09 17:22:22,085 WARNING pydefect.input_maker.defect_entry_set_maker    Va_O1_2 already exists, so nothing is done.
```
and no directories are newly created. 
This is a fail-safe treatment not to delete the calculated directories by mistake.
If you really overwrite the directories, you can use the `--force_overwrite` option.

In each directory, we can find the `defect_entry.json` file, containing information about a point defect obtained before the first-principles calculations.
To see summary of `defect_entry.json`, type
```
python ~/my_bin/pydefect/pydefect/main.py de --print
```

When you'd like to add some particular defects, you can use
```
python ~/my_bin/pydefect/pydefect/main.py dvos -d Va_O1_-1
```
With this command, `Va_O1_-1/` is created.

### Creation of complex defect directories
TBA
<!--
We often want to calculate complex defects, peculiar defects such as DX centers, defects with different initial structures, and in such cases, need to construct `POSCAR`s by hand.
However, pydefect can generate `defect_entry.json` by parsing the `POSCAR` and `INCAR` files for the defect.
When `defect_entry.json` is generated, the directory name is parsed.
If one wants to calculate the same defect but with different atomic structure, we can use the `annotation`.

The directory is parsed as follows.
```
 AA_BB_CC_2_XX_YY_ZZ/ -> name='AA_BB_CC', charge=2, annotation='XX_YY_ZZ'
```
For example, 
```
             Va_Mg1_2/ -> name = "Va_Mg1",       charge =  2, annotation = None
      Va_O1_-2_inward/ -> name = "Va_O1",        charge = -2, annotation = "inward"
Mg_i+Va_O1*2_2_coord1/ -> name = "Mg_i+Va_O1*2", charge =  2, annotation = "coord1"
```

Therefore, create the directory following this rule and make `POSCAR` as you want and type the following command to generate the other vasp input set.
```
python ~/my_bin/pydefect/pydefect/main.py vos -t defect -x pbesol --dirs . --charge -1
```
where the charge is assumed to be -1.

And then, type 
```
python ~/my_bin/pydefect/pydefect/main.py de --make_defect_entry
```
to generate `defect_entry.json`.

<p> We also recommend the users to use &Gamma; version of vasp if the k-point sampling is only &Gamma; point for very large supercells.</p>
-->

### 9. Generation of supercell information related to point-defect calculations
After (partly) finishing the vasp calculations, we next generate the `dft_results.json` 
that contains the first-principles calculation results related to the defect properties.

By using the `supercell_results` (=`sr`) sub-command like,
```
python ~/my_bin/pydefect/pydefect/main.py sr --dir_all
```
you can generate `dft_results.json` in all the directories.
When you want to parse some particular directories, *e.g.*, Va_O1_0, type
```
python ~/my_bin/pydefect/pydefect/main.py sr --dirs Va_O1_0
```

Here, the name of `perfect/` has special meaning, so users **must** use this name for the supercells without defects.



### 10. Corrections of defect formation energies in finite-size supercells 
When supercell method is adopted, obtained total energies for **charged defects** are not properly estimated due to interaction between a defect, its images, and background charge. 
Therefore, we need to correct total energies of charged defect supercells to predict those in dilute limit.

The corrections are attained using the `extended_fnv_correction` (=`efc`) sub-command,
```
python ~/my_bin/pydefect/pydefect/main.py efc --unitcell_json ../unitcell/unitcell.json --perfect_json perfect/dft_results.json
```

For the corrections, we need the dielectric constants and atomic site potential of perfect supercell.
Therefore, the paths to `unitcell.json` and `dft_results.json` of `perfect` must be assigned.
Bear also in mind that this command takes some time, so we recommend the users to prepare coffee or go on a walk outside during this process.

The correction method adopted in pydefect at this moment is the so-called extended Freysoldt-Neugebauer-Van de Walle (eFNV) method.
so if one uses the corrections, please cite the following papers.
- [Y. Kumagai*, and F. Oba, Electrostatics-based finite-size corrections for first-principles point defect calculations, Phys. Rev. B, 89 195205 (2014).](https://journals.aps.org/prb/abstract/10.1103/PhysRevB.89.195205)
- [C. Freysoldt, J. Neugebauer, C. Van de Walle, Fully Ab Initio Finite-Size Corrections for Charged-Defect Supercell Calculations, Phys. Rev. Lett., 102 016402 (2009).](https://journals.aps.org/prl/abstract/10.1103/PhysRevLett.102.016402)

You obtain potential.eps file, which contains information about defect-induced and point-charge potential, 
and their differences at each atomic site as shown below.

The width and height of the horizontal line indicate the averaged region and ∆VPC, q/b|far, respectively. 
When performing the corrections, I strongly recommend you to check all the potential.eps files of your calculated defects so as to reduce careless mistakes as much as possible.

### 11. Check defect eigenvalues
Then, we need to generate `defect.json` files in all the defect directories.
For this purpose, type,
```
python ~/my_bin/pydefect/pydefect/main.py d 
```

Some calculations might not be finished properly or still ongoing.
To see whether the calculations are properly finished, one can use the `diagnose` (=`d`) option
```
python ~/my_bin/pydefect/pydefect/main.py d -d
```
which shows like
```
  Va_Ba1_-1/  convergence : F    band edge : UP  :    No in-gap state  DOWN  :       Acceptor PHS
  Va_Ba1_-2/  convergence : T    band edge : UP  :    No in-gap state  DOWN  :    No in-gap state
   Va_Ba1_0/  No supercell results file.
    Va_O1_0/  convergence : T    band edge : UP  :    Localized state  DOWN  :    Localized state
    Va_O1_1/  convergence : T    band edge : UP  :    Localized state  DOWN  :    Localized state
    Va_O1_2/  convergence : T    band edge : UP  :    Localized state  DOWN  :    Localized state
  Va_Sn1_-1/  convergence : T    band edge : UP  :    No in-gap state  DOWN  :    Localized state
  Va_Sn1_-2/  convergence : T    band edge : UP  :    Localized state  DOWN  :    Localized state
  Va_Sn1_-3/  convergence : T    band edge : UP  :    Localized state  DOWN  :    Localized state
  Va_Sn1_-4/  convergence : T    band edge : UP  :    Localized state  DOWN  :    Localized state
   Va_Sn1_0/  convergence : T    band edge : UP  :    No in-gap state  DOWN  :    Localized state
```
If the convergences at the electronic and/or ionic step are not attained, convergence is shown as `F`.
Net to the convergence, we can see band edge information at the spin up (UP) and down (DOWN) channels, which will be explained later.

### 11. Check defect eigenvalues
Generally, point defects are divided into three types.

First type is the defects with deep localized states inside the band gap. 
This type of defect is considered to be detrimental for device performances as the carriers are trapped by the localized states.
Therefore, in the theoretical researches, it is important to know the position of the localized state and its origin.

Second type is the defects without any defect states, which should not affect the electronic properties as long as their concentrations are sufficiently low.

Third type is the defects with hydrogenic states, or perturbed host states (PHS), which are carriers locating at the band edges loosely trapped by the defects.
An examples are the B-on-Si (p-type) and P-on-Si (n-type) in Si.
This type of defect also do little harm for device performances, but introduce the carrier electrons.
The wavefunctions of the PHS widespread to several million atoms, so we need to calculate such supergiant supercells to estimate their thermodynamical transition levels.  
Instead, we thus describe that `the defects have PHS and their transition energies locate near band edges` only qualitatively.
See, for examples.
- [Y. Kumagai*, M. Choi, Y. Nose, and F. Oba, First-principles study of point defects in chalcopyrite ZnSnP2, Phys. Rev. B, 90 125202 (2014).](https://link.aps.org/pdf/10.1103/PhysRevB.90.125202)
- [Y. Kumagai*, L. A. Burton, A. Walsh, and F. Oba, Electronic structure and defect physics of tin sulfides: SnS, Sn2S3, and SnS2, Phys. Rev. Applied, 6 014009 (2016).](https://link.aps.org/doi/10.1103/PhysRevApplied.6.014009)
- [Y. Kumagai*, K. Harada, H. Akamatsu, K. Matsuzaki, and F. Oba, Carrier-Induced Band-Gap Variation and Point Defects in Zn3N2 from First Principles, Phys. Rev. Applied, 8 014015 (2017).](https://journals.aps.org/prapplied/abstract/10.1103/PhysRevApplied.8.014015)
- [Y. Kumagai*, N. Tsunoda, and F. Oba, Point defects and p-type doping in ScN from first principles, Phys. Rev. Applied, 9 034019 (2018).](https://journals.aps.org/prapplied/abstract/10.1103/PhysRevApplied.9.034019)
- [N. Tsunoda, Y. Kumagai*, A. Takahashi, and F. Oba, Electrically benign defect behavior in ZnSnN2 revealed from first principles, Phys. Rev. Applied, 10 011001 (2018).](https://journals.aps.org/prapplied/abstract/10.1103/PhysRevApplied.10.011001)

Due to such a situation, it is important to see the defect levels and judge if the carriers create the PHS or defect localized states.
pydefect show the calculated eigenvalues and the band-edge states by the `eigenvalues` (=`eig`) sub-command
```
python ~/my_bin/pydefect/pydefect/main.py eig --defect_dir . --unitcell ../../unitcell/unitcell.json --perfect ../perfect/dft_results.json -s eig.png
```
or using the diagnose sub-command as shown above.

The given `eig.png` looks like
![V<sub>Mg</sub><sup>-2</sup>](eig1.png)
![V<sub>Mg</sub><sup>0</sup>](eig2.png)
![Mg<sub>i</sub><sup>0</sup>](eig3.png)

These are examples of V<sub>Mg</sub><sup>-2</sup> and V<sub>Mg</sub><sup>0</sup> in MgSe.
Here, one can see occupations of single-particle levels in the spin-up and -down channels.
The x-axis and y-axis are fractional coordinates of sampled k points and single-particle energy in the absolute scale, respectively.
Filled circles inside the figures are eigenenergies in the defect supercells.
There are also five lines, namely VBM and CBM in the unitcell (**blue**), those in the perfect supercell (**red**), and the Fermi level in the defect supercells.
The numbers in the figure indicate the band indices, which are shown discretely.

The filled circles are categorized into blue, green, orange ones which mean the occupied, partially occupied (from 0.1 to 0.9), unoccupied eigenstates in the defect supercell, respectively. 
The  

We emphasize that the automatically determined band-edge states could be incorrect as it is difficult to determine them.
Therefore, please carefully check the band-edge states, and draw the band-decomposed charge density states if the band-edge states are not so obvious.

If you find the automatically determined band-edge states are incorrect, you can modify it by
```
python ~/my_bin/pydefect/pydefect/main.py sr -be up acceptor_phs --dirs .
```
and
```
python ~/my_bin/pydefect/pydefect/main.py sr -be down acceptor_phs --dirs .
```
for both spin-up and -down states.
There are four supported states `donor_phs`, `acceptor_phs`, `localized_state`, `no_in_gap`, the former two are considered as shallow states, and omitted for energy plot by default.


### 12. Plot defect formation energies
Here, we show how to plot the defect formation energies.

The plot of the defect formation energies requires a wide variety of information, namely
band edges, chemical potentials of competing phases, total energy of perfect supercell.

Here, we plot the defect formation energies as a function of the Fermi level with the `plot_energy` (=`pe`) sub-command
```
python ~/my_bin/pydefect/pydefect/main.py pe --unitcell ../unitcell/unitcell.json --perfect perfect/dft_results.json --defect_dirs Va*_* --chem_pot_yaml ../competing_phases/vertices_*.yaml -x -1 8 -s energy_A.pdf
```
which shows like,
![](energy.png)

This command
Once the calculation directories are parsed, `defect_energies.json` is automatically generated.
If one wants to regenerate the results, one needs to remove it.

If one wants to change the condition for chemical potential, namely the position of vertex in
the chemical potential diagram, use `--chem_pot_label` option.

There are many options for this sub-command.
For instance, if one wants to restrict the plot only for the nitrogen vacancies, one 
can use `--filtering` option like,
```
python ~/my_bin/pydefect/pydefect/main.py pe --unitcell ../unitcell/unitcell.json --perfect perfect/dft_results.json --defect_dirs Va*_* --chem_pot_yaml ../competing_phases/vertices_*.yaml -x -1 8 -s energy_A.pdf
```

### 13. Show local structure information
We also regularly check local structures around defects.
`pydefect` can show the local structure information by text using the following command.
```
python ~/my_bin/pydefect/pydefect/main.py ls
```
which shows an example of V<sub>Se</sub><sup>-2</sup> in MgSe, e.g.,
```
element initial   final   disp  angle            
 name   dist(A)  dist(A)  dist  (deg)   direction
    Mg    2.57     3.72   1.15   180      outward
    Mg    2.56     3.20   0.64   174      outward
    Mg    2.56     3.20   0.64   174      outward
    Mg    2.56     3.20   0.64   175      outward
```
where the defect position is assumed to locate at the original Se atomic site. 

### 14. Calculate the carrier and defect concentrations 
We can also calculate the carrier and defect concentrations using the defect formation energies using `pydefect`.
For the calculations, `unitcell.json` and `defect_energies.json` are needed.
When one wants to calculate the equilibrium carrier and defect concentrations at 1000K, use the `concentrations` (=`c`) sub-command as follows:
```
 python ~/my_bin/pydefect/pydefect/main.py c --unitcell ../unitcell/unitcell.json -t 1000
```
which shows
```
++ Equilibrium concentration
Temperature: 1000.0 K.
Fermi level from vbm: 1.98 eV.
            p: 9.3e+10 cm-3.
            n: 2.0e+16 cm-3.
        p - n: -2.0e+16 cm-3.
---
      Mg_i1_2: 1.0e+16 cm-3.
---
     Se_i1_-2: 1.4e+02 cm-3.
---
    Va_Mg1_-1: 3.7e+04 cm-3.
    Va_Mg1_-2: 8.9e+07 cm-3.
     Va_Mg1_0: 2.4e-03 cm-3.
---
     Va_Se1_0: 3.4e+16 cm-3.
     Va_Se1_1: 2.8e+12 cm-3.
     Va_Se1_2: 1.8e+10 cm-3.

++ Quenched equilibrium concentration
Temperature: 298 K.
Fermi level from vbm: 2.38 eV.
            p: 0.0e+00 cm-3.
            n: 2.0e+16 cm-3.
        p - n: -2.0e+16 cm-3.
---
      Mg_i1_2: 1.0e+16 cm-3.
---
     Se_i1_-2: 1.4e+02 cm-3.
---
    Va_Mg1_-1: 1.2e-11 cm-3.
    Va_Mg1_-2: 8.9e+07 cm-3.
     Va_Mg1_0: 5.9e-43 cm-3.
---
     Va_Se1_0: 3.4e+16 cm-3.
     Va_Se1_1: 2.0e-05 cm-3.
     Va_Se1_2: 6.9e-19 cm-3.
```

Since these concentrations are calculated in a selfconsistent (SC) manner, the calculations sometimes do not converge.
In such case, we can check the selfconsistent iterations using the `verbose` (=`v`) option. 

 
    
